# Security Guidelines for Sigil Identity Management

## Overview

Sigil uses Nostr keypairs as the sole cryptographic identity mechanism. Your private key is the master secret that controls all your actions in the Sigil ecosystem. Losing it means permanent loss of access. Compromising it means an attacker can impersonate you.

## Passphrase Security

### Requirements

- **Minimum length**: 12 characters (enforced)
- **Complexity**: Must contain at least 2 different character types:
  - Lowercase letters (a-z)
  - Uppercase letters (A-Z)
  - Numbers (0-9)
  - Symbols (!@#$%^&\*()\_+-=[]{}|;:'",.<>?/~`)

### Recommendations

- **Use a password manager** to generate and store strong passphrases
- **Avoid common words, patterns, or personal information** (names, birthdays, etc.)
- **Never reuse passphrases** from other services
- **Minimum recommended length**: 16+ characters for high-value identities

### Examples

❌ **Weak passphrases** (will be rejected or easily cracked):

- `password123` (too short, too common)
- `12345678` (no complexity, sequential)
- `aaaaaaaa` (same character repeated)

✅ **Strong passphrases**:

- `Tr0ub4dor&3-Style!` (16 chars, mixed types)
- `correct-horse-battery-staple-42` (diceware-style)
- Generated by password manager (best option)

## Backup and Recovery

### Critical Warning

**There is NO password reset mechanism.** If you lose your passphrase or identity file, you **permanently lose access** to your Sigil identity. There is no customer support that can recover it.

### Backup Your Identity

1. **Export your keypair** for offline backup:

   ```typescript
   import { loadKeypair, exportKeypair } from '@sigil/client';

   const keypair = await loadKeypair('your-passphrase');
   const exported = exportKeypair(keypair);

   // Store these SECURELY (offline, encrypted storage):
   console.log('Private key (nsec):', exported.privateKey.nsec);
   console.log('Private key (hex):', exported.privateKey.hex);
   ```

2. **Store backups securely**:
   - ✅ **Encrypted USB drive** stored in a safe location
   - ✅ **Hardware security module (HSM)** or hardware wallet
   - ✅ **Encrypted cloud backup** with a different strong passphrase
   - ✅ **Paper wallet** in a fireproof safe
   - ❌ **NEVER** plain text on your computer
   - ❌ **NEVER** in email, cloud notes, or messaging apps
   - ❌ **NEVER** in screenshots or photos

3. **Backup the encrypted identity file**:
   - Default location: `~/.sigil/identity`
   - Backup this file along with your passphrase (stored separately)
   - File is encrypted, but still treat as sensitive

### Recovery Process

If you lose your identity file but have a backup of your private key:

```typescript
import { importPrivateKey, saveKeypair } from '@sigil/client';

// Import from nsec (bech32 format)
const keypair = await importPrivateKey('nsec1...', 'nsec');

// Or import from hex
const keypair = await importPrivateKey('0a1b2c...', 'hex');

// Save with NEW passphrase
await saveKeypair(keypair, 'your-new-strong-passphrase');
```

If you have a BIP-39 seed phrase backup:

```typescript
import { importFromSeedPhrase, saveKeypair } from '@sigil/client';

const seedPhrase = 'abandon abandon abandon ... art'; // 24 words
const keypair = await importFromSeedPhrase(seedPhrase);
await saveKeypair(keypair, 'your-new-strong-passphrase');
```

## Key Rotation

Currently, Sigil does **not support key rotation**. Once you create an identity, you cannot change the underlying keypair without creating a new identity.

**Workaround for compromised keys**:

1. Create a new identity with a new keypair
2. Migrate all data/assets to the new identity (if possible)
3. Announce the compromise and new identity to relevant parties
4. **Never use the compromised key again**

## Rate Limiting and Brute Force Protection

The SDK implements automatic rate limiting to prevent brute-force attacks:

- **Maximum failed attempts**: 5 per 5-minute window
- **Delay after limit**: 3 seconds before next attempt allowed
- **Counter reset**: Automatic after 5 minutes of no activity
- **Counter storage**: Persisted in the encrypted identity file

This means an attacker with access to your identity file would need:

- ~3 seconds per password attempt after the first 5 attempts
- Years to brute-force even a moderately weak 8-character password
- Impossible to brute-force a strong 12+ character password in any realistic timeframe

## Private Key Handling

### Never Expose Private Keys

The SDK is designed to **never expose your private key** outside the encryption layer:

- ✅ `client.identity.publicKey` - Safe to share
- ✅ `client.identity.sign(event)` - Signs without exposing key
- ❌ `client.identity.privateKey` - **Does not exist** (by design)

### Memory Security

The SDK implements best-effort memory clearing:

- Encryption keys are zeroed after use
- Decrypted buffers are cleared after parsing
- JavaScript limitations: V8 may still have copies in memory

For maximum security, consider:

- Running in an isolated environment
- Restarting the process after sensitive operations
- Using OS-level memory encryption (if available)

## Dependency Security

The SDK uses minimal, well-audited cryptographic dependencies:

- `nostr-tools` - Nostr protocol implementation
- `@scure/bip39` - BIP-39 seed phrase handling
- `@clockworklabs/spacetimedb-sdk` - SpacetimeDB integration

All dependencies are:

- Pinned to exact versions (no automatic updates)
- Regularly audited for known vulnerabilities
- From trusted, maintained projects

Run `pnpm audit` in the `packages/client` directory to check for known vulnerabilities.

## Reporting Security Vulnerabilities

If you discover a security vulnerability in Sigil:

1. **DO NOT** open a public GitHub issue
2. Email security@bitcraft.com with:
   - Description of the vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if any)
3. Allow 90 days for responsible disclosure before public announcement

## OWASP Top 10 Compliance

This implementation addresses OWASP Top 10 (2021) relevant to cryptographic identity:

- **A02 - Cryptographic Failures**: ✅ AES-256-GCM encryption, scrypt KDF, secure key generation
- **A03 - Injection**: ✅ No dynamic code execution, no SQL/command injection vectors
- **A04 - Insecure Design**: ✅ Defense in depth, rate limiting, secure defaults
- **A05 - Security Misconfiguration**: ✅ Secure file permissions, strong crypto parameters
- **A07 - Identification and Authentication**: ✅ Cryptographic identity, no weak credentials
- **A08 - Data Integrity Failures**: ✅ GCM authenticated encryption, signature verification
- **A09 - Logging Failures**: ✅ No private key logging, secure error messages
- **A10 - SSRF**: ✅ No network requests in identity module

## Additional Resources

- [Nostr Protocol Specification](https://github.com/nostr-protocol/nips)
- [NIST Cryptographic Standards](https://csrc.nist.gov/publications/fips)
- [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)
